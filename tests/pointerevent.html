<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
	<meta name="viewport" content="width=500">
	<title>pointer event</title>
	<link rel="stylesheet" type="text/css" href="testindex.css">
	<script src="testglobals.js"></script>
	<script src="testgeneric.js"></script>
	<!-- custom -->
	<style>
		table {width: 480px;}
		.reset {
			float: left;
			display: flex;
			align-items: center;
			justify-content: center;
			height: 50px;
			width: 100px;
			color: var(--test0);
			border: 2px solid var(--test7);
			cursor: pointer;
			margin-bottom: 20px;
		}
		.pointer {
			float: left;
			display: flex;
			align-items: center;
			justify-content: center;
			height: 240px;
			width: 100px;
			color: var(--test0);
			border: 2px solid var(--test7);
			cursor: pointer;
		}
		.flex-item {
			text-align: center;
			margin: 10px;
		}
	</style>
</head>

<body>

	<table>
	<tr><td><h2>TorZillaPrint</h2></td></tr>
	<tr><td class="blurb"><a class="return" href="../index.html#devices">return to TZP index</a></td></tr>
	</table>

	<table id="tb7">
		<col width="35%"><col width="65%">
		<thead><tr><th colspan="2">
			<div class="nav-title">pointer event</div>
		</th></tr></thead>
		<tr><td colspan="2"></td></tr>
		<tr>
			<td>
				<div class="reset" id="reset"><div class="flex=item" id="resettext">START</div></div>
				<div class="pointer" id="target">
					<div class="flex-item"><br>CLICK<br><br>or<br><br>TOUCH<br><br>this<br><br>TARGET</div>
				</div>
			</td>
			<td class="mono" style="text-align: left; vertical-align: top;">
				<div class="s6">OVERALL HASH <span class="no_color" id="hash"></span></div><br></div>
				<div class="s4"><u>POINTER</u> <span class="no_color" id="pointerhash"></span></div><br><div class="no_color spaces" id="results"></div>
				<div class="s4"><u>TOUCH</u> <span class="no_color" id="touchhash"></span></div><br><div class="no_color spaces" id="touch"></div><hr><br>
				<div class="s6 spaces">  maxTouchPoints <span class="no_color" id="maxTouchPoints"></span></div></div><br>
				<div class="s6 spaces">touch properties <span class="no_color" id="touch_properties"></span></div><br>
				<div class="s6 spaces">      touch keys <span class="no_color" id="touch_keys"></span></div><br><hr><br>
				<div class="s4"><u>EVENTS</u></div><br><div class="no_color" id="events"></div>
			</td>
		</tr>
	</table>
	<br>

<script>
'use strict';
// https://bugzilla.mozilla.org/show_bug.cgi?id=1363508

let padlen = 18
let oData = {'pointerdown': {}, 'pointerover': {}}
let oTouch = {} // touch! doh!!
let oHash = {
	'pointer': '',
	'maxTouchPoints': '',
	'touch': '',
	'touch_properties': '',
	'touch_keys': '',
}
let isStart = true
let setEvents = new Set()

function finish() {
	if (0 == Object.keys(oData['pointerdown']).length) {return}
	if (0 == Object.keys(oData['pointerover']).length) {return}
	if (oHash['touch_keys'] !== 'none' && 0 == Object.keys(oTouch).length) {return}
	// yay
	let hash = mini(oHash)
	dom.hash = hash
	console.log('hash\n', oHash)
	console.log('pointer\n', oData)
	console.log('touch\n', oTouch)
}

function runtouch(event, type) {
	// return if we already captured it
	if (0 !== Object.keys(oTouch).length) {return}
	addEvent(type)

	let oTemp = [], oDisplay = []
	try {
		let touch = event.touches[0]
		// these are all numbers
		let aList = [
			'force', // float 0.0 (no pressure) - 1.0 (max pressure)
			'radiusX','radiusY',
			'rotationAngle',
			'screenX','clientX', // RFP these should match
			'screenY','clientY', // ^ ditto
		]
		aList.forEach(function(k){
			let value
			try {
				value = touch[k]
				if ('number' !== typeof value) {
					value = 'err'
				} else if (Number.isNaN(value)) {
					value = 'NaN'
				}
			} catch(e) {
				value = e.name
			}
			oTemp[k] = value
		})
		// screen matches client
		let matchX = false, matchY = false
		let A = oTemp['clientX'], B = oTemp['screenX']
		if ('number' == typeof A && 'number' == typeof B) {matchX = A === B}
		oTouch['client_screenX'] = matchX
		oDisplay.push(s6 + ('client|screen X').padStart(padlen) +": "+ sc + A +' | '+ B +' '+ (matchX ? '[valid match]' : '[!match]'))
		let C = oTemp['clientY'], D = oTemp['screenY']
		if ('number' == typeof C && 'number' == typeof D) {matchY = C === D}
		oTouch['client_screenY'] = matchY
		oDisplay.push(s6 + ('client|screen Y').padStart(padlen) +": "+ sc + C +' | '+ D +' '+ (matchY ? '[valid match]' : '[!match]'))

		let aRemainder = ['force','radiusX','radiusY','rotationAngle']
		aRemainder.forEach(function(k){
			let value = oTemp[k]
			oTouch[k] = value
			oDisplay.push(s6 + k.padStart(padlen) +": "+ sc + value)
		})
		dom.touch.innerHTML = oDisplay.join("<br>") + '<br><br>'
		let hash = mini(oTouch)
		oHash['touch'] = hash
		dom.touchhash = hash
		finish()
	} catch(e) {
		dom.touch.innerHTML = e+'<br>'
	}
}

function run(event, type) {
	// return if we already captured it
	if (0 !== Object.keys(oData[type]).length) {return}
	addEvent(type)

	let oList = {
		isPrimary: "boolean", // RFP true
		pressure: "number", // RFP: 0 if not active, 0.5 if active
		mozPressure: "number",
		pointerType: "string", // RFP mouse
		mozInputSource: "number", // mouse = 1, pen = 2, touch = 5
		tangentialPressure: "number", // RFP 0
		tiltX: "number", // RFP 0
		tiltY: "number", // RFP 0
		twist: "number", // RFP 0
		width: "number", // RFP 1
		height: "number", // RFP 1
		altitudeAngle: "number",
		azimuthAngle: "number",
	}
	let oTemp = {}, oDisplay = []

	for (const k of Object.keys(oList)) {
		let value
		try {
			value = event[k]
			let	expected = oList[k]
			if (typeof value !== expected) {
				value = 'err'
			} else if ("number" == expected && Number.isNaN(value)) {
				value = 'NaN'
			}
		} catch(e) {
			value = e.name
		}
		oTemp[k] = value
	}
	// sort
	for (const k of Object.keys(oTemp).sort()) {oData[type][k] = oTemp[k]}

	// build display
	let lines = ["pressure", "pointerType", "tangentialPressure", "altitudeAngle"]
	let divider = "<span class='faint'>" + "----------".padStart(padlen) +"--------"+ sc
	let eventstr = '',
		isDown = Object.keys(oData['pointerdown']).length > 0,
		isOver = Object.keys(oData['pointerover']).length > 0
	if (isOver && !isDown) {eventstr = 'pointerover'
	} else if (!isOver && isDown) {eventstr = 'pointerdown'
	} else {eventstr = 'pointerover | down'}

	for (const k of Object.keys(oList)) {
		if (lines.includes(k)) {
			oDisplay.push(divider)
		}
		let strActive = k.includes('ressure') ? ' [active]' : ''
		let valueDown = oData['pointerdown'][k],
			valueOver = oData['pointerover'][k]
		let str
		if (valueDown == undefined) {str = valueOver
		} else if (valueOver == undefined) {str = valueDown + strActive
		} else {
			if (valueDown == valueOver) {str = valueDown
			} else {str = valueOver + " | " + valueDown + strActive}
		}
		oDisplay.push(s6 + k.padStart(padlen) +": "+ sc + str)
	}
	// display
	// only display when we have both events
	if (setEvents.has('pointerover') && setEvents.has('pointerdown')) {
		let hash = mini(oData)
		oHash['pointer'] = hash
		dom.pointerhash.innerHTML = hash
		dom.results.innerHTML = oDisplay.join("<br>") + '<br><br>'
		finish()
	}
}

function addEvent(type) {
	setEvents.add(type)
	let aEvents = Array.from(setEvents)
	dom.events.innerHTML = aEvents.join("<br>")
}

function reset() {
	oData['pointerdown'] = {}
	oData['pointerover'] = {}
	oTouch = {}

	oHash.pointer = ''
	oHash.touch = ''

	// force mouse out of target area
	if (isStart) {
		start()
		dom.resettext.innerHTML = 'RESET'
		isStart = false
	} else {
		dom.results = ''
		dom.touch = ''
		dom.events = ''
		dom.hash = ''
		dom.touchhash = ''
		dom.pointerhash = ''
		setEvents.clear()
	}
}

function start() {
	let target = dom.target
	target.addEventListener("pointerdown", (event) => {run(event, 'pointerdown')})
	target.addEventListener("pointerover", (event) => {run(event, 'pointerover')})
	target.addEventListener("touchstart", (event) => {runtouch(event, 'touchstart')})

	let oEvents = {
		'mouse': ['down','enter','leave','move','out','over','up'],
		'pointer': ['cancel','enter','leave','move','out','up'],
		'touch': ['cancel','end','move'],
	}
	for (const k of Object.keys(oEvents)) {
		let list = oEvents[k]
		list.forEach(function(type){
			target.addEventListener(k + type, (event) => {addEvent(k + type)})
		})
	}
}

function run_once() {
	let hash
	// maxtouchpoints
	try {
		hash = navigator.maxTouchPoints
	} catch(e){
		hash = zErr
	}
	oHash['maxTouchPoints'] = hash
	dom['maxTouchPoints'].innerHTML = hash
	// keys
	hash = ''
	let list = ''
	try {
		let parser = new DOMParser
		let doc = parser.parseFromString('<div>', "text/html")
		let htmlElement = doc.body.firstChild
		//let data = Object.getOwnPropertyNames(contentWindow)
		let data = []
		for (const key in htmlElement) {
			if (key.includes('Touch') || key.includes('touch')) {data.push(key)}
		}
		hash = (data.length > 0 ? mini(data) : "none")
		list = (data.length > 0 ? '<br><br>'+ data.join("<br>") : '')
	} catch(e) {
		list = e+''
		hash = zErr
	}
	oHash['touch_keys'] = hash
	dom['touch_keys'].innerHTML = hash + list
	// properties
	let id = 'iframe-window-version'
	hash = '', list = ''
	try {
		// create & append
		let el = document.createElement('iframe')
		el.setAttribute('id', id)
		el.setAttribute('style', 'display: none')
		document.body.appendChild(el)
		// get props
		let iframe = dom[id]
		let contentWindow = iframe.contentWindow
		let data = Object.getOwnPropertyNames(contentWindow)
		let props = []
		data.forEach(function(item){
			if (item.includes('Touch') || item.includes('touch')) {props.push(item)}
		})
		props = props.sort()
		hash = (props.length > 0 ? mini(props) : "none")
		list = (props.length > 0 ? '<br><br>'+ props.join("<br>") : '')
	} catch(e) {
		list = e+''
		hash = zErr
	}
	removeElementFn(id)
	oHash['touch_properties'] = hash
	dom['touch_properties'].innerHTML = hash + list
}

function get_window_props() {

}

let targetreset = dom.reset
targetreset.addEventListener("pointerover", (event) => {reset()})
run_once()


</script>
</body>
</html>
